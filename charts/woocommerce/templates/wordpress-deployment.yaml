apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "woocommerce.fullname" . }}-wordpress
  labels:
    {{- include "woocommerce.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: wordpress
      {{- include "woocommerce.selectorLabels" . | nindent 6 }}
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/component: wordpress
        {{- include "woocommerce.selectorLabels" . | nindent 8 }}
    spec:
      {{- if .Values.wordpress.setup.enabled }}
      initContainers:
        - name: wp-setup
          image: wordpress:cli
          env:
            - name: WP_CLI_PHP_ARGS
              value: "-d memory_limit={{ .Values.wordpress.setup.phpMemoryLimit }}"
            - name: DB_HOST
              value: {{ include "woocommerce.fullname" . }}-mysql
            - name: DB_NAME
              value: {{ .Values.mysql.database }}
            - name: DB_USER
              value: {{ .Values.mysql.user }}
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "woocommerce.fullname" . }}-secret
                  key: mysql-password
            - name: SITE_URL
              value: "http://{{ .Values.ingress.host }}"
            - name: SITE_TITLE
              value: {{ .Values.wordpress.setup.siteTitle | quote }}
            - name: ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: {{ include "woocommerce.fullname" . }}-secret
                  key: wp-admin-user
            - name: ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "woocommerce.fullname" . }}-secret
                  key: wp-admin-password
            - name: ADMIN_EMAIL
              valueFrom:
                secretKeyRef:
                  name: {{ include "woocommerce.fullname" . }}-secret
                  key: wp-admin-email
            - name: PRODUCT_TITLE
              value: {{ .Values.wordpress.setup.sampleProductTitle | quote }}
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -eu
              WP_CLI="php -d memory_limit={{ .Values.wordpress.setup.phpMemoryLimit }} /usr/local/bin/wp"
              if [ -f /var/www/html/wp-config.php ]; then
                echo "WordPress already configured, skipping setup."
                exit 0
              fi
              $WP_CLI core download --path=/var/www/html --allow-root
              $WP_CLI config create --path=/var/www/html --dbname="$DB_NAME" --dbuser="$DB_USER" --dbpass="$DB_PASSWORD" --dbhost="$DB_HOST" --skip-check --allow-root
              for i in $(seq 1 30); do
                if $WP_CLI db check --path=/var/www/html --allow-root >/dev/null 2>&1; then
                  break
                fi
                sleep 5
              done
              $WP_CLI core install --path=/var/www/html --url="$SITE_URL" --title="$SITE_TITLE" --admin_user="$ADMIN_USER" --admin_password="$ADMIN_PASSWORD" --admin_email="$ADMIN_EMAIL" --skip-email --allow-root
              $WP_CLI plugin install woocommerce --activate --allow-root
              $WP_CLI option update woocommerce_enable_guest_checkout yes --allow-root
              $WP_CLI option update woocommerce_enable_checkout_login_reminder yes --allow-root
              $WP_CLI option update woocommerce_default_country "US:CA" --allow-root
              $WP_CLI option update woocommerce_currency "USD" --allow-root
              $WP_CLI option update woocommerce_cod_settings '{"enabled":"yes","title":"Cash on Delivery","instructions":"Pay with cash upon delivery."}' --format=json --allow-root
              PRODUCT_ID=$($WP_CLI post create --post_type=product --post_title="$PRODUCT_TITLE" --post_status=publish --porcelain --allow-root)
              $WP_CLI post meta update "$PRODUCT_ID" _regular_price "19.99" --allow-root
              $WP_CLI post meta update "$PRODUCT_ID" _price "19.99" --allow-root
              {{- range .Values.wordpress.setup.sampleProducts }}
              EXTRA_PRODUCT_ID=$($WP_CLI post create --post_type=product --post_title={{ .title | quote }} --post_status=publish --porcelain --allow-root)
              $WP_CLI post meta update "$EXTRA_PRODUCT_ID" _regular_price {{ .price | quote }} --allow-root
              $WP_CLI post meta update "$EXTRA_PRODUCT_ID" _price {{ .price | quote }} --allow-root
              {{- end }}
          volumeMounts:
            - name: wordpress-persistent-storage
              mountPath: /var/www/html
          resources:
            {{- toYaml .Values.wordpress.setup.resources | nindent 12 }}
      {{- end }}
      containers:
        - name: wordpress
          image: "{{ .Values.wordpress.image }}"
          env:
            - name: WORDPRESS_DB_HOST
              value: {{ include "woocommerce.fullname" . }}-mysql
            - name: WORDPRESS_DB_USER
              value: {{ .Values.mysql.user }}
            - name: WORDPRESS_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "woocommerce.fullname" . }}-secret
                  key: mysql-password
            - name: WORDPRESS_DB_NAME
              value: {{ .Values.mysql.database }}
          ports:
            - containerPort: 80
              name: wordpress
          resources:
            {{- toYaml .Values.wordpress.resources | nindent 12 }}
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 20
            timeoutSeconds: 3
            failureThreshold: 5
          volumeMounts:
            - name: wordpress-persistent-storage
              mountPath: /var/www/html
      volumes:
        - name: wordpress-persistent-storage
          persistentVolumeClaim:
            claimName: {{ include "woocommerce.fullname" . }}-wordpress
