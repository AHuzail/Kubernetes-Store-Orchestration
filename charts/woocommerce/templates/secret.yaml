{{- $secretName := printf "%s-secret" (include "woocommerce.fullname" .) -}}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $rootPassword := "" -}}
{{- $userPassword := "" -}}
{{- $headerToken := "" -}}
{{- $adminUser := "" -}}
{{- $adminPassword := "" -}}
{{- $adminEmail := "" -}}
{{- if $existing }}
  {{- $rootPassword = (index $existing.data "mysql-root-password" | default "" | b64dec) -}}
  {{- $userPassword = (index $existing.data "mysql-password" | default "" | b64dec) -}}
  {{- $headerToken = (index $existing.data "header-auth-token" | default "" | b64dec) -}}
  {{- $adminUser = (index $existing.data "wp-admin-user" | default "" | b64dec) -}}
  {{- $adminPassword = (index $existing.data "wp-admin-password" | default "" | b64dec) -}}
  {{- $adminEmail = (index $existing.data "wp-admin-email" | default "" | b64dec) -}}
{{- else }}
  {{- $rootPassword = (default (randAlphaNum 24) .Values.mysql.rootPassword) -}}
  {{- $userPassword = (default (randAlphaNum 24) .Values.mysql.password) -}}
  {{- $headerToken = (randAlphaNum 32) -}}
  {{- $adminUser = (default "admin" .Values.wordpress.setup.adminUser) -}}
  {{- $adminPassword = (default (randAlphaNum 24) .Values.wordpress.setup.adminPassword) -}}
  {{- $adminEmail = (default "admin@example.com" .Values.wordpress.setup.adminEmail) -}}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "woocommerce.labels" . | nindent 4 }}
type: Opaque
data:
  header-auth-token: {{ $headerToken | b64enc | quote }}
  mysql-root-password: {{ $rootPassword | b64enc | quote }}
  mysql-password: {{ $userPassword | b64enc | quote }}
  wp-admin-user: {{ $adminUser | b64enc | quote }}
  wp-admin-password: {{ $adminPassword | b64enc | quote }}
  wp-admin-email: {{ $adminEmail | b64enc | quote }}
