{{- $secretName := printf "%s-secret" (include "medusa.fullname" .) -}}
{{- $existing := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $postgresPassword := "" -}}
{{- $jwtSecret := "" -}}
{{- $cookieSecret := "" -}}
{{- $adminPassword := "" -}}
{{- $adminEmail := "" -}}
{{- if $existing }}
  {{- $postgresPassword = (index $existing.data "postgres-password" | default "" | b64dec) -}}
  {{- $jwtSecret = (index $existing.data "jwt-secret" | default "" | b64dec) -}}
  {{- $cookieSecret = (index $existing.data "cookie-secret" | default "" | b64dec) -}}
  {{- $adminPassword = (index $existing.data "admin-password" | default "" | b64dec) -}}
  {{- $adminEmail = (index $existing.data "admin-email" | default "" | b64dec) -}}
{{- else }}
  {{- $postgresPassword = (default (randAlphaNum 24) .Values.postgres.password) -}}
  {{- $jwtSecret = (default (randAlphaNum 32) .Values.medusa.jwtSecret) -}}
  {{- $cookieSecret = (default (randAlphaNum 32) .Values.medusa.cookieSecret) -}}
  {{- $adminPassword = (default (randAlphaNum 24) .Values.medusa.adminPassword) -}}
  {{- $adminEmail = (default "admin@example.com" .Values.medusa.adminEmail) -}}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "medusa.labels" . | nindent 4 }}
type: Opaque
data:
  postgres-password: {{ $postgresPassword | b64enc | quote }}
  jwt-secret: {{ $jwtSecret | b64enc | quote }}
  cookie-secret: {{ $cookieSecret | b64enc | quote }}
  admin-password: {{ $adminPassword | b64enc | quote }}
  admin-email: {{ $adminEmail | b64enc | quote }}
